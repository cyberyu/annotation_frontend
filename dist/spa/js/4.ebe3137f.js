(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[4],{"0cf5":function(t,e,s){"use strict";s("1e29")},"1e29":function(t,e,s){},"41e63":function(t,e,s){"use strict";var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("q-btn-dropdown",{staticStyle:{width:"150px"},attrs:{label:t.mode.toUpperCase()+" "+(t.review?"Review":t.consensus?"Consensus":""),"no-caps":"",icon:"ner"===t.mode?"category":"sentence"===t.mode?"view_list":"share",flat:"",align:"between",size:"0.9em","text-color":"primary"}},[s("q-list",{attrs:{separator:""}},[s("q-item",{attrs:{clickable:"",ripple:""},nativeOn:{click:function(e){t.$router.push({name:"annotate",params:{project:t.project,review:t.review,consensus:t.consensus}}).catch((function(t){}))}}},[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{name:"category"}})],1),s("q-item-section",[t._v("\n       NER\n      ")])],1),s("q-item",{attrs:{clickable:"",ripple:""},nativeOn:{click:function(e){t.$router.push({name:"sentenceAnnotate",params:{project:t.project,review:t.review,consensus:t.consensus}}).catch((function(t){}))}}},[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{name:"view_list"}})],1),s("q-item-section",[t._v("\n        Sentence\n      ")])],1),s("q-item",{attrs:{clickable:"",ripple:""},nativeOn:{click:function(e){t.$router.push({name:"relation",params:{project:t.project,review:t.review,consensus:t.consensus}}).catch((function(t){}))}}},[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{name:"share"}})],1),s("q-item-section",[t._v("\n        Relation\n      ")])],1)],1)],1)},o=[],i={name:"AnnotateTab",props:{mode:{type:String,required:!0},project:{type:Object},review:{type:Boolean,default:!1},consensus:{type:Boolean,default:!1}}},a=i,l=s("a6c2"),r=s("edd5"),c=s("692f"),h=s("e0e9"),d=s("6c44"),u=s("19dc"),p=s("63c1"),m=s.n(p),f=Object(l["a"])(a,n,o,!1,null,null,null);e["a"]=f.exports;m()(f,"components",{QBtnDropdown:r["a"],QList:c["a"],QItem:h["a"],QItemSection:d["a"],QIcon:u["a"]})},d2d9:function(t,e,s){"use strict";s.r(e);var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("q-page",{staticStyle:{"background-color":"#f6f6f6"}},[s("div",{staticClass:"row self-start items-center",staticStyle:{"margin-top":"-8px"}},[s("q-breadcrumbs",{staticClass:"justify-start"},[s("q-breadcrumbs-el",{attrs:{label:"My Projects",icon:"home",to:"/"}}),s("q-breadcrumbs-el",{attrs:{label:"Project Summary",icon:"widgets",to:"/project/"+t.project.id}}),s("q-breadcrumbs-el",[s("AnnotateTab",{attrs:{project:t.project,review:t.review,consensus:t.consensus,mode:t.mode}})],1)],1)],1),s("div",{staticClass:"row self-start q-pt-lg"},[this.review?s("div",{staticClass:"col-2"}):s("div",{staticClass:"col-3"},[s("div",{staticClass:"justify-end  q-pr-md row"},[s("q-card",{staticClass:"col-8"},[s("q-linear-progress",{attrs:{size:"25px",value:t.progressStats.pct,color:"accent"}},[s("div",{staticClass:"absolute-full flex flex-center"},[s("q-badge",{attrs:{color:"white","text-color":"accent",label:t.progressStats.label}})],1)]),s("q-tabs",{staticClass:"text-grey",attrs:{dense:"","active-color":"primary","indicator-color":"primary",align:"justify","narrow-indicator":""},model:{value:t.tab,callback:function(e){t.tab=e},expression:"tab"}},[s("q-tab",{attrs:{name:"models",label:t.consensus?"Consensus Models":"Models"}}),t.consensus?t._e():s("q-tab",{attrs:{name:"rules",label:"Rules"}}),t.consensus?t._e():s("q-tab",{attrs:{name:"dicts",label:"Dictionaries"}})],1),s("q-separator"),s("q-tab-panels",{attrs:{animated:""},model:{value:t.tab,callback:function(e){t.tab=e},expression:"tab"}},[t.consensus?s("q-tab-panel",{attrs:{name:"models"}},t._l(t.cmodels,(function(e,n){return s("div",{key:n,staticClass:"q-pa-sm"},[s("q-btn",{staticClass:"bg-primary",attrs:{loading:t.modelQueue.indexOf(t.tab+e.id)>=0,disable:t.processedQ.indexOf(t.tab+e.id)>=0,label:e.name,"text-color":"white"},on:{click:function(s){return t.executeModel(e.id)}},scopedSlots:t._u([{key:"loading",fn:function(){return[s("q-spinner-hourglass",{staticClass:"on-left"}),t._v("\n                      Loading...\n                    ")]},proxy:!0}],null,!0)}),t.cmodels[e.id]&&t.cmodels[e.id].consensusScore?s("div",[t.cmodels[e.id].consensusScore.total?s("span",[s("span",{staticClass:"text-bold text-primary"},[t._v("Accum F1")]),t._v(": "+t._s(t.cmodels[e.id].consensusScore.total.toFixed(1))+"\n                    ")]):t._e(),t.cmodels[e.id].consensusScore.f1?s("span",{staticClass:"q-pl-sm"},[s("span",{staticClass:"text-bold text-positive"},[t._v("F1")]),t._v(": "+t._s(t.cmodels[e.id].consensusScore.f1.toFixed(1))+"\n                    ")]):t._e()]):t._e(),s("q-tooltip",{attrs:{"content-class":"bg-indigo",delay:1e3,offset:[10,10],"max-width":"250px"}},[t._v(" "+t._s(e.note)+" ")])],1)})),0):s("q-tab-panel",{attrs:{name:"models"}},[t._l(t.vmodels,(function(e,n){return s("div",{key:n,staticClass:"q-pa-sm"},[s("q-btn",{staticClass:"bg-primary",attrs:{loading:t.modelQueue.indexOf(t.tab+e.id)>=0,disable:t.processedQ.indexOf(t.tab+e.id)>=0,label:e.name,"text-color":"white"},on:{click:function(s){return t.executeModel(e.id)}},scopedSlots:t._u([{key:"loading",fn:function(){return[s("q-spinner-hourglass",{staticClass:"on-left"}),t._v("\n                      Loading...\n                    ")]},proxy:!0}],null,!0)}),s("q-tooltip",{attrs:{"content-class":"bg-indigo",delay:1e3,offset:[10,10],"max-width":"250px"}},[t._v(" "+t._s(e.note)+" ")])],1)})),0===t.vmodels.length?s("div",[t._v("\n                  No model defined for this project yet\n                ")]):t._e()],2),s("q-tab-panel",{attrs:{name:"rules"}},[t._l(t.rules,(function(e,n){return s("div",{key:n,staticClass:"q-pa-sm"},[s("q-btn",{staticClass:"bg-primary",attrs:{loading:t.modelQueue.indexOf(t.tab+e.id)>=0,disable:t.processedQ.indexOf(t.tab+e.id)>=0,label:e.name,"text-color":"white"},on:{click:function(s){return t.executeModel(e.id)}},scopedSlots:t._u([{key:"loading",fn:function(){return[s("q-spinner-hourglass",{staticClass:"on-left"}),t._v("\n                      Loading...\n                    ")]},proxy:!0}],null,!0)}),s("q-tooltip",{attrs:{"content-class":"bg-indigo",delay:1e3,offset:[10,10],"max-width":"250px"}},[t._v(" "+t._s(e.note)+" ")])],1)})),0===t.rules.length?s("div",[t._v("\n                  No rule defined for this project yet\n                ")]):t._e()],2),s("q-tab-panel",{attrs:{name:"dicts"}},[t._l(t.dicts,(function(e,n){return s("div",{key:n,staticClass:"q-pa-sm"},[s("q-btn",{staticClass:"bg-primary",attrs:{loading:t.modelQueue.indexOf(t.tab+e.id)>=0,disable:t.processedQ.indexOf(t.tab+e.id)>=0,label:e.name,"text-color":"white"},on:{click:function(s){return t.executeModel(e.id)}},scopedSlots:t._u([{key:"loading",fn:function(){return[s("q-spinner-hourglass",{staticClass:"on-left"}),t._v("\n                      Loading...\n                    ")]},proxy:!0}],null,!0)}),s("q-tooltip",{attrs:{"content-class":"bg-indigo",delay:1e3,offset:[10,10],"max-width":"250px"}},[t._v(" "+t._s(e.note)+" ")])],1)})),0===t.dicts.length?s("div",[t._v("\n                  No dictionary defined for this project yet\n                ")]):t._e()],2)],1)],1)],1)]),s("div",{staticClass:"col-6 bg-white"},[s("q-card-actions",{staticClass:"bg-white annotation-header"},[s("div",{staticClass:"row full-width"},[s("div",{staticClass:"col-12 text-center"},[t.relevantSentences.length>0?s("q-btn",{staticClass:"q-mr-xs",staticStyle:{width:"100px"},attrs:{label:t.showUnRelated?"Hide unrelated":"Show all",flat:"","no-caps":"",size:"sm"},on:{click:function(e){t.showUnRelated=!t.showUnRelated}}}):t._e()],1),s("div",{staticClass:"row items-center justify-between",staticStyle:{width:"282px"}},[s("div",{staticClass:"row justify-between col-12"},[s("q-btn",{staticClass:"q-mr-xs",staticStyle:{width:"120px"},attrs:{outline:"",label:t.relation.head.text,"no-caps":""}}),s("br"),s("q-btn",{attrs:{icon:"swap_horiz",size:"sm",flat:""},on:{click:function(e){return t.switchHeadTail()}}}),s("q-btn",{staticClass:"q-mr-xs",staticStyle:{width:"120px"},attrs:{outline:"",label:t.relation.tail.text,"no-caps":""}})],1),s("div",{staticClass:"row justify-around col-12"},[s("span",{on:{click:function(e){t.relation.head={}}}},[t._v("Head")]),s("span",{on:{click:function(e){t.relation.tail={}}}},[t._v("Tail")])])]),s("div",{staticClass:"col row self-center q-px-sm"},[s("div",{staticClass:"row items-start"},[s("q-btn-dropdown",{attrs:{color:"primary",unelevated:"",label:t.relation.relation?t.relation.relation.name:"relation"}},[s("q-list",t._l(t.relationLabels,(function(e,n){return s("q-item",{directives:[{name:"close-popup",rawName:"v-close-popup"}],key:n,attrs:{clickable:"",dense:""},on:{click:function(s){return t.setLabel(e)}}},[s("q-item-label",[t._v("\n                        "+t._s(e.name)+"\n                      ")])],1)})),1)],1)],1),s("q-input",{staticClass:"col q-ml-sm",attrs:{dense:"",label:"suggesting text",hint:"select or manually type text which suggests such relation",filled:""},model:{value:t.relation.hint.text,callback:function(e){t.$set(t.relation.hint,"text",e)},expression:"relation.hint.text"}})],1),s("div",{staticClass:"column self-center"},[s("q-btn",{staticClass:"block float-right",attrs:{color:"primary",size:"sm"},on:{click:function(e){return t.resetRelation()}}},[t._v("Reset")]),s("q-btn",{staticClass:"q-mt-xs block float-right",attrs:{color:"accent",size:"sm",disable:!t.goodRelation},on:{click:function(e){return t.confirmRelation()}}},[t._v("Confirm")])],1)])]),s("q-separator"),s("q-scroll-area",{ref:"textArea",staticClass:"col",staticStyle:{height:"calc(100vh - 200px)",display:"flex"}},[t.tokens&&t.tokens.length>0?s("div",{staticClass:"select-box q-pa-sm",attrs:{tabindex:"0"},on:{keyup:t.key,focusout:function(e){t.selected=[]}}},[s("svg",{staticStyle:{position:"absolute",width:"100%",height:"100%"}},[s("defs",[s("marker",{attrs:{id:"head",orient:"auto",markerWidth:"6",markerHeight:"4",refX:"0.1",refY:"2"}},[s("path",{attrs:{d:"M0,0 V4 L2,2 Z",fill:"green"}})])]),s("path",{attrs:{id:"rel-1","marker-end":"url(#head)",d:"M0 0",stroke:"green","stroke-width":"3","stroke-linecap":"round",fill:"transparent"}})]),t._l((t.showUnRelated,t.tokens),(function(e,n){return s("div",{key:n,class:t.getTokenBlockClass(e,n),attrs:{id:"t-"+n}},[s("span",{staticClass:"q-pt-xs token",staticStyle:{position:"relative"},attrs:{id:t.selected[0]===n?"selected":null},on:{mousedown:function(e){t.selectStart(n),t.mousePressed=!0},mouseup:function(e){t.selectEnd(n),t.mousePressed=!1,t.addRelationText()},mouseover:function(e){t.mousePressed&&t.select(n)}}},[s("span",{class:t.getTokenClass(n)},[t._v(t._s(e[0]))]),t._l(t.detailedAnnotations[n],(function(e,o){return s("div",{key:o,class:""+t.getPosOfLabel(n,o,e).order,style:t.getPosOfLabel(n,o,e).cls})}))],2),t.detailedAnnotations[n]?s("span",{staticClass:"label",class:{"active-label shadow-4":t.activeLabel==="l-"+n},staticStyle:{position:"absolute"},style:"margin-top: "+(2.2+.25*t.detailedAnnotations[n].length+t.prevTight(n))+"em",attrs:{id:"l-"+n},on:{mouseover:function(e){t.activeLabel="l-"+n},mouseleave:function(e){t.activeLabel=null}}},t._l(t.detailedAnnotations[n],(function(e,n){return s("span",{key:"label"+n,staticClass:"label",style:"color:"+t.getColor(e[1])},["B"===e[0]?s("span",{style:"margin-left:"+(2*n-4)+"px"},[s("span",{on:{click:function(s){return t.setHeadTail(e[1])}}},[t._v(t._s(e[1].name))])]):t._e()])})),0):t._e(),t.detailedAnnotations[n]?s("span",{style:"height: "+(18*t.detailedAnnotations[n].filter((function(t){return"B"==t[0]})).length+4*t.detailedAnnotations[n].length)+"px"}):t._e()])}))],2):t._e()]),s("q-separator"),s("q-card-actions",{staticClass:"justify-center"},[s("div",{staticClass:"row items-center"},[t._v("\n              Go to page "),s("q-input",{staticClass:"q-pl-xs",staticStyle:{"max-width":"5em"},attrs:{type:"number",dense:""},model:{value:t.go2page,callback:function(e){t.go2page=t._n(e)},expression:"go2page"}}),s("q-btn",{staticClass:"float-right q-ml-md",attrs:{color:"primary",label:"Go"},on:{click:function(e){return t.fetchDocs({page:t.go2page})}}})],1),s("q-space"),s("q-btn",{staticClass:"justify-center",staticStyle:{width:"100px"},attrs:{color:"primary",label:"Previous",disable:!t.prevURL},on:{click:function(e){return t.fetchDocs({url:t.prevURL})}}}),s("q-btn",{staticClass:"justify-center q-ml-md",staticStyle:{width:"100px"},attrs:{color:"accent",label:"Save",loading:t.saving},on:{click:function(e){return t.saveAnnotations()}},scopedSlots:t._u([{key:"loading",fn:function(){return[t._v("\n                     Saving...\n                   ")]},proxy:!0}])}),s("q-btn",{staticClass:"justify-center q-ml-md",staticStyle:{width:"100px"},attrs:{color:"primary",label:"Next"},on:{click:function(e){t.nextURL?t.fetchDocs({url:t.nextURL}):t.$router.push("/")}}})],1)],1),s("div",{staticClass:"col-3 summary q-mb-none"},[s("q-card",[s("q-card-actions",{staticClass:"bg-accent annotation-header justify-between",style:"color: white; font-weight: bold; font-size: 1.2em"},[s("q-btn",{class:{"bg-purple-5":"annotations"==t.showTab},attrs:{label:"ANNOTATIONS",flat:""},on:{click:function(e){t.showTab="annotations"}}},[s("q-badge",{attrs:{color:"info",floating:""}},[t._v(" "+t._s(t.relations.length))])],1),s("q-btn",{staticClass:"float-right",class:{"bg-purple-5":"sort"==t.showTab},attrs:{icon:"sort",flat:""},on:{click:function(e){t.showTab="sort"}}},[t.modelResultCache?s("q-badge",{attrs:{color:"info",floating:""}},[t._v(" "+t._s(t.modelResultCache.length))]):t._e()],1),t.review?s("q-btn",{staticClass:"float-right",class:{"bg-purple-5":"annotators"==t.showTab},attrs:{icon:"group",flat:""},on:{click:function(e){t.showTab="annotators"}}},[t.annotations4Review?s("q-badge",{attrs:{color:"info",floating:""}},[t._v(" "+t._s(Object.keys(t.annotations4Review).length))]):t._e()],1):t._e(),s("q-btn",{staticClass:"float-right",class:{"bg-purple-5":"conflicts"==t.showTab},attrs:{icon:"visibility",flat:""},on:{click:function(e){t.showTab="conflicts"}}},[s("q-badge",{attrs:{color:"red",floating:""}},[t._v(t._s(Object.keys(t.conflicts).length))])],1)],1),s("q-scroll-area",{staticClass:"col",staticStyle:{height:"calc(100vh - 180px)",display:"flex"}},[t.tokens&&"annotations"===t.showTab?s("relation-list",{attrs:{relations:t.relations},on:{remove:function(e){return t.removeRelation(e)},select:function(e){t.relation=e,t.drawRelation(e)}}}):t._e(),t.tokens&&t.modelResultCache&&"sort"===t.showTab?s("relation-list",{attrs:{relations:t.modelResultCache,showAccept:!0},on:{remove:function(e){return t.removeRelationFromModelCache(e)},accept:function(e){t.relations.push(e),t.removeRelationFromModelCache(e)},select:function(e){t.relation=e,t.drawRelation(e)}}}):t._e(),t.tokens&&t.modelResultCache&&"sort"===t.showTab?s("div",{staticClass:"flex justify-center"},[s("q-btn",{staticClass:"q-mt-sm",attrs:{label:"Clear model results",color:"primary"},on:{click:function(e){t.modelResultCache=null}}})],1):t._e(),t.tokens&&"conflicts"===t.showTab?s("q-list",{staticClass:"bg-white",attrs:{bordered:"",separator:""}},[0===Object.keys(t.conflicts).length?s("span",{staticClass:"text-subtitle2 q-pa-sm"},[t._v(" Cool, there is no conflict")]):t._e(),t._l(Object.entries(t.conflicts),(function(e,n){return s("q-item",{key:n,attrs:{label:e[0]+" ("+e[1].length+")"}},[s("div",{},t._l(e[1],(function(e,n){return s("div",{key:n,staticStyle:{"list-style":"circle"}},[s("span",[e.m?s("q-avatar",{attrs:{color:"red",size:"12px","text-color":"white"},on:{click:function(s){return t.removeAnnotation(e.tpos[0],e)}}},[t._v(" m ")]):s("q-avatar",{attrs:{size:"12px"}}),s("span",{on:{click:function(s){return t.scrollTo(e)}}},[t._v(t._s(e.pos)+" - "+t._s(e.text)+" 【"+t._s(e.name)+"】")])],1)])})),0)])}))],2):t._e(),t.tokens&&"annotators"===t.showTab?s("q-list",{staticClass:"bg-white",attrs:{bordered:"",separator:""}},t._l(t.annotations4Review,(function(e,n,o){return s("q-expansion-item",{directives:[{name:"ripple",rawName:"v-ripple"}],key:o,staticClass:"q-pr-xs",attrs:{clickable:"",label:e.author+" ("+e.annotations.length+")",active:t.activeAuthors.includes(n),group:"review","active-class":"bg-blue-3 text-grey-8"},on:{click:function(e){return t.getAnnotations(n)}}},[s("div",{staticClass:"col-12 text-center"},[s("q-btn-group",{attrs:{outline:""}},[s("q-btn",{class:{"bg-positive":1===e.status},attrs:{outline:"",label:"Accept"},on:{click:function(s){return t.rejectOrAccept(e,1)}}}),s("q-btn",{class:{"bg-negative":-1===e.status},attrs:{outline:"",label:"Reject"},on:{click:function(s){return t.rejectOrAccept(e,-1)}}}),s("q-btn",{class:{"bg-negative":2===e.status},attrs:{outline:"",label:"Redo"},on:{click:function(s){return t.rejectOrAccept(e,2)}}})],1)],1),s("relation-list",{attrs:{relations:t.relations},on:{remove:function(e){t.removeRelation(e),t.resetRelation()},select:function(e){t.relation=e,t.drawRelation(e)}}})],1)})),1):t._e()],1)],1)],1)])])},o=[],i=s("c8ef"),a=s.n(i),l=(s("534d"),s("68e1"),s("f0ae")),r=s("41e63"),c=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("q-list",{staticClass:"bg-white",attrs:{dense:"",separator:""}},t._l(t.relations,(function(e,n){return s("q-item",{key:n,staticClass:"column",class:t.curRel===n?"bg-indigo-2":"",nativeOn:{click:function(s){t.$emit("select",e),t.curRel=n}}},[s("div",{staticClass:"row col-12 items-center"},[s("span",{staticClass:"text-bold rel-part"},[t._v("Relation: ")]),s("span",{staticClass:"rel-pos"},[t._v(t._s(e.relation.name))]),s("q-icon",{attrs:{name:"cancel"},on:{click:function(s){s.stopPropagation(),t.$emit("remove",e),t.curRel=null}}}),t.showAccept?s("q-icon",{attrs:{name:"check_circle"},on:{click:function(s){return s.stopPropagation(),t.$emit("accept",e)}}}):t._e()],1),s("div",{staticClass:"row col-12"},[s("span",{staticClass:"text-bold rel-part"},[t._v("Head: ")]),s("span",{staticClass:"rel-pos"},[t._v("["+t._s(e.head.pos[0])+" - "+t._s(e.head.pos[1])+"]")]),t._v("\n      - "+t._s(e.head.text)+"\n    ")]),s("div",{staticClass:"row col-12"},[s("span",{staticClass:"text-bold rel-part"},[t._v("Hint: ")]),e.hint.pos?s("span",{staticClass:"rel-pos"},[t._v("["+t._s(e.hint.pos[0])+" - "+t._s(e.hint.pos[1])+"] ")]):s("span",{staticClass:"rel-pos"}),t._v("\n      - "+t._s(e.hint.text)+"\n    ")]),s("div",{staticClass:"row col-12"},[s("span",{staticClass:"text-bold rel-part"},[t._v("Tail: ")]),s("span",{staticClass:"rel-pos"},[t._v("["+t._s(e.tail.pos[0])+" - "+t._s(e.tail.pos[1])+"] ")]),t._v("\n      - "+t._s(e.tail.text)+"\n    ")])])})),1)},h=[],d={name:"RelationList",props:{relations:Array,showAccept:Boolean},data(){return{curRel:null}}},u=d,p=s("a6c2"),m=s("692f"),f=s("e0e9"),g=s("19dc"),b=s("63c1"),v=s.n(b),w=Object(p["a"])(u,c,h,!1,null,"9792821c",null),x=w.exports;v()(w,"components",{QList:m["a"],QItem:f["a"],QIcon:g["a"]});const y={relation:null,head:{},tail:{},hint:{}};var k={name:"RelationAnnotate",mixins:[l["a"]],components:{RelationList:x,AnnotateTab:r["a"]},data(){return{mode:"relation",relationLabels:{},relationLabelNames:new Set,relations:[],relationSelected:null,relationText:null,relation:a()({},y)}},mounted(){this.project.labels.filter((t=>"ner"===t.kind)).forEach((t=>{this.labels[t.id]=t,this.labelNames.add(t.name)})),this.project.labels.filter((t=>t.kind===this.mode)).forEach((t=>{this.relationLabels[t.id]=t,this.relationLabelNames.add(t.name)}))},methods:{getAnnotations(t){this.document.relations=this.annotations4Review[t],this.relations=this.annotations4Review[t].annotations},getTokenBlockClass(t,e){let s="";return s+=t[0].includes("\r")||t[0].includes("\n")?"row":"column inline",s},setHeadTail(t){this.relation.head.text?this.relation.tail.text||(this.relation.tail=t):this.relation.head=t,this.relation.head.pos&&this.relation.tail.pos&&this.drawRelation(this.relation)},switchHeadTail(){const t=this.relation.head;this.relation.head=this.relation.tail,this.relation.tail=t,this.drawRelation(this.relation)},addRelationText(){const t=this.tokens[this.start][2],e=this.tokens[this.end][2]+(this.tokens[this.end][0].length-1),s={pos:[t,e],tpos:[this.start,this.end],text:this.document.text.substring(t,e+1)};this.relation.hint=s},setLabel(t){this.relation.relation=t,this.$forceUpdate()},resetRelation(){this.relation=a()({},y);const t=document.getElementById("rel-1");t.setAttribute("d",""),this.$forceUpdate()},confirmRelation(){for(let t=0;t<=this.relations.length;t++)if(this.relations[t]===this.relation)return;this.relations.push(this.relation),this.resetRelation()},removeRelation(t){const e=this.relations.indexOf(t);this.relations.splice(e,1),this.$forceUpdate()},removeRelationFromModelCache(t){const e=this.modelResultCache.indexOf(t);this.modelResultCache.splice(e,1),this.$forceUpdate()},_getOffset(t){const e=t.getBoundingClientRect();return{left:e.left+window.pageXOffset,top:e.top+window.pageYOffset,offsetLeft:t.offsetLeft,offsetTop:t.offsetTop,width:e.width,height:e.height}},drawRelation(t){let e=document.getElementById(`t-${t.head.tpos[0]}`),s=document.getElementById(`t-${t.tail.tpos[0]}`);e=this._getOffset(e),s=this._getOffset(s);let n=e.offsetLeft+e.width/2,o=e.offsetTop+e.height/2,i=s.offsetLeft+s.width/2,a=s.offsetTop+s.height/2;o<a&&n<i&&(o+=18,a-=28,n+=e.width/2,i=s.offsetLeft),o>a&&n>i&&(a+=20,o=e.offsetTop,n=e.offsetLeft+e.width/2),o>a&&n<i&&(a+=0,o-=28,i-=s.width/2+14),o<a&&n>i&&(o+=0,a-=28,n=e.offsetLeft-10),o===a&&(o-=28,a-=28);const l=.5*(i+n),r=.5*(a+o);let c;if(o===a){const t=Math.atan2(a-o,i-n)-Math.PI/2,e=30,s=l+e*Math.cos(t),h=r+e*Math.sin(t);c="M"+n+" "+o+" Q "+s+" "+h+" "+i+" "+a}else c="M"+n+" "+o+" Q "+l+" "+r+" "+i+" "+a;const h=document.getElementById("rel-1");h.setAttribute("d",c)},executeModel(t){this.add2Q(t);const e={mtype:this.tab,id:t,document:this.document.id},s=this.consensus?"/api/calculate_consensus/":"/api/model-relation/";this.$axios.post(this.$hostname+s,e).then((e=>{const s=e.data;this.removeFromQ(t),this.modelResultCache?this.modelResultCache=this.modelResultCache.concat(s):this.modelResultCache=s,this.modelResultCache.sort(((t,e)=>e.confidence-t.confidence));const n=`Finished running model, and got ${s.length} results`;this.$q.notify({message:n,color:"secondary",position:"center",timeout:0,actions:[{label:"Dismiss",color:"white",handler:()=>{}},{label:"Review",color:"white",handler:()=>{this.showTab="sort"}}]}),this.consensus&&(this.cmodels[t].consensusScore={f1:100*e.data.f1,total:100*e.data.total})})).catch((e=>{console.log(e.response.data.error),this.alertServerErr(),this.removeFromQ(t)}))}},computed:{goodRelation(){return this.relation.head.text&&this.relation.tail.text&&this.relation.relation&&this.relation.relation.name}},watch:{}},_=k,C=(s("0cf5"),s("505d")),q=s("e3ff"),A=s("8367"),R=s("5ce7"),S=s("a805"),Q=s("ec38"),j=s("6471"),$=s("9ad2"),T=s("3f5f"),O=s("eb48"),L=s("9efb"),E=s("ef9c"),I=s("2d8d"),B=s("3676"),M=s("1038"),P=s("84df"),D=s("edd5"),U=s("dc7c"),F=s("a3be"),N=s("b51c"),z=s("d6e3"),H=s("dc01"),K=s("953d"),G=s("6c44"),J=s("1631"),W=s("f6b1"),Y=s("a561"),V=Object(p["a"])(_,n,o,!1,null,null,null);e["default"]=V.exports;v()(V,"components",{QPage:C["a"],QBreadcrumbs:q["a"],QBreadcrumbsEl:A["a"],QCard:R["a"],QLinearProgress:S["a"],QBadge:Q["a"],QTabs:j["a"],QTab:$["a"],QSeparator:T["a"],QTabPanels:O["a"],QTabPanel:L["a"],QBtn:E["a"],QSpinnerHourglass:I["a"],QTooltip:B["a"],QCircularProgress:M["a"],QCardActions:P["a"],QBtnDropdown:D["a"],QList:m["a"],QItem:f["a"],QItemLabel:U["a"],QInput:F["a"],QScrollArea:N["a"],QIcon:g["a"],QAvatar:z["a"],QSpace:H["a"],QExpansionItem:K["a"],QItemSection:G["a"],QBtnGroup:J["a"]}),v()(V,"directives",{ClosePopup:W["a"],Ripple:Y["a"]})},f0ae:function(t,e,s){"use strict";s.d(e,"a",(function(){return n}));s("534d"),s("68e1");const n={name:"CommAnnoMixin",props:["project","review","consensus"],data(){return{mode:null,documents:[],document:null,tokens:null,sentences:null,relevantSentences:[],start:null,end:null,labels:{},labelNames:new Set,doneFetchLabels:!1,annotations:[],detailedAnnotations:[],selected:[],highlighted:[],mousePressed:!1,nextURL:null,prevURL:null,tab:"models",loading:!1,saving:!1,currentModel:null,modelQueue:[],processedQ:[],offsetTop:null,isAnnotated:null,numAnnotated:0,annotations4Review:null,showTab:"annotations",activeAuthors:[],feedback:"",modelResultCache:null,activeLabel:null,annotationOrders:null,cmodels:{},rules:[],dicts:[],vmodels:[],consensusScore:null,go2page:"",showUnRelated:!0}},mounted(){this.project.rules.filter((t=>t.kind===this.mode)).forEach((t=>{this.rules.push(t)})),this.project.dicts.filter((t=>t.kind===this.mode)).forEach((t=>{this.dicts.push(t)})),this.project.vmodels.filter((t=>t.kind===this.mode)).forEach((t=>{this.vmodels.push(t)})),this.project.cmodels.filter((t=>t.kind===this.mode)).forEach((t=>{this.cmodels[t.id]=t,this.cmodels[t.id].consensusScore={f1:null,total:null}}));const t={id:null,description:"a dummy label for labels which were created in the project",color:"#e0e0e0",name:"NULL"};this.labels.null=t;const e={id:"misc",description:"misc",color:"#e0e0e0",name:"MISC"};this.labels.misc=e,this.review||this.consensus?this.fetchDocs({}):this.fetchDocs({page:this.project.first_unannotated}),setTimeout((()=>{this.$forceUpdate()}))},methods:{alertServerErr(){this.$q.notify({message:"Oops, something went wrong on the server",color:"negative",position:"center",actions:[{label:"Dismiss",color:"white",handler:()=>{}}]})},initialLabels(t){},rejectOrAccept(t,e){t.status=t.status===e?0:e;const s=`/api/annotations/${t.id}/`,n={status:t.status};this.$axios.patch(s,n).then((t=>{console.log(t.data)})),this.annotations=this.mergeAnnotations(this.activeAuthors),this.getDetailedAnnotations(),this.$forceUpdate()},getAnnotations(t){const e=this.activeAuthors.indexOf(t);e>=0?this.activeAuthors.splice(e,1):this.activeAuthors.push(t),this.annotations=this.mergeAnnotations(this.activeAuthors),"ner"===this.mode?this.getDetailedAnnotations():"sentence"===this.mode&&this.prepareCatAnnotations()},mergeAnnotations(t){t&&0!==t.length||(t=Object.keys(this.annotations4Review));const e=t.length;let s=[];for(let n=0;n<e;n++){const e=this.annotations4Review[t[n]];-1!==e.status&&(s=s.concat(e.annotations.map((t=>(t.author=e.author,t)))))}return s.forEach((t=>t.authors=[])),s=s.filter(((t,e,n)=>e===n.findIndex((n=>String(n.pos)===String(t.pos)&&n.name===t.name&&(("ner"===this.mode||"sentence"===this.mode&&n.category===t.category)&&n.authors.push(s[e].author),!0))))),s},getColor(t){return this.labels[t.id].color},getPosOfLabel(t,e,s){const n=this.annotationOrders[t][this.getKey(s)],o=1+4*n,i=`\n      margin-top: ${o}px;\n      position: absolute;\n      width:calc(100% - ${"B"===s[0]?4+2*n:0}px);\n      border-bottom: solid ${this.getColor(s[1])} 2px;\n      margin-left: ${"B"===s[0]?4+2*n:0}px\n      `;return{order:n,pos:o,name:s.name,cls:i}},prevTight(t){let e=0;return 0===t||!this.detailedAnnotations[t-1]||this.detailedAnnotations[t-1].length<1?e:(this.detailedAnnotations[t-1].forEach((t=>{const s=this.tokens[t[1].tpos[0]][0];"B"===t[0]&&s.length<t[1].name.length&&(e+=1)})),0===e?0:e-Math.floor(this.detailedAnnotations[t].length/4))},add2Q(t){const e=this.tab+t;this.modelQueue.push(e)},removeFromQ(t){const e=this.tab+t,s=this.modelQueue.indexOf(e);this.modelQueue.splice(s,1),this.processedQ.push(e)},existInAnnotations(t){return this.annotations.some((e=>e.pos[0]===t.pos[0]&&e.pos[1]===t.pos[1]&&e.name===t.name))},findAnnotation(t,e){let s;return this.detailedAnnotations[t].forEach((t=>{t[1].id===e&&(s=t[1])})),s},executeModel(t){this.add2Q(t);const e={mtype:this.tab,id:t,document:this.document.id},s=this.consensus?"/api/calculate_consensus/":"/api/calculate/";this.$axios.post(this.$hostname+s,e).then((e=>{const s=e.data.result;this.alignTokens(s),s.forEach((t=>{t.m="m",t.id=this.lLabels[t.name]?this.lLabels[t.name].id:null;const e=t;this.existInAnnotations(e)||this.annotations.push(e)})),this.getDetailedAnnotations(),this.removeFromQ(t),this.modelResultCache?this.modelResultCache=this.modelResultCache.concat(s):this.modelResultCache=s,this.modelResultCache.sort(((t,e)=>e.confidence-t.confidence));const n=`Finished running model, and got ${s.length} results`;this.$q.notify({message:n,color:"secondary",position:"center",timeout:0,actions:[{label:"Dismiss",color:"white",handler:()=>{}},{label:"Review",color:"white",handler:()=>{this.showTab="sort"}}]}),this.consensus&&(this.cmodels[t].consensusScore={f1:100*e.data.f1,total:100*e.data.total})})).catch((e=>{console.log(e.response.data.error),this.alertServerErr(),this.removeFromQ(t)}))},scrollTo(t){let e=t.tpos;e[0]>e[1]&&(e=[e[0],e[0]]);const s=`t-${e[0]}`;this.highlighted=Array(e[1]-e[0]+1).fill(e[0]).map(((t,e)=>t+e)),console.log(t,this.highlighted),document.getElementById(s).scrollIntoView({block:"center"})},selectStart(t){this.start=t,this.selected=[t]},selectEnd(t){this.end=t,this.end<this.start&&(this.end=this.start,this.start=t)},select(t){const e=Math.min(t,this.start),s=Math.max(t,this.start);this.selected=[...Array(s-e+1).keys()].map((t=>t+e))},getTokenClass(t){let e="";return e=this.detailedAnnotations[t]?this.detailedAnnotations[t][0][0]:"",e+=this.selectedClasses[t],e+=" q-pl-sm",e+=this.highlighted.includes(t)?" highlight":"",this.showUnRelated||this.tokensInRS.includes(t)||(e+=" unrel"),"relation"===this.mode&&(this.relation.head.tpos&&this.relation.head.tpos[0]<=t&&this.relation.head.tpos[1]>=t&&(e+=" bg-yellow"),this.relation.tail.tpos&&this.relation.tail.tpos[0]<=t&&this.relation.tail.tpos[1]>=t&&(e+=" bg-yellow"),this.relation.hint.tpos&&this.relation.hint.tpos[0]<=t&&this.relation.hint.tpos[1]>=t&&(e+=" bg-yellow")),e},isPunct(t){const e=".,!\"'",s=this.tokens[t][0][0];return e.includes(s)},getWidth(t,e){let s=0;const n=this.detailedAnnotations[t][e][1].tpos;for(let o=n[0];o<n[1]+1;o++){const t=document.getElementById("t-"+o);t&&(s+=t.offsetWidth)}return s},annotate(t){const e=this.tokens[this.start][2],s=this.tokens[this.end][2]+(this.tokens[this.end][0].length-1),n={id:t.id,name:t.name,pos:[e,s],tpos:[this.start,this.end],text:this.document.text.substring(e,s+1)};for(let o=0;o<this.annotations.length;o++){const e=this.annotations[o];if(e.pos[0]===n.pos[0]&&e.pos[1]===n.pos[1]){if(e.id===t.id)return alert("already there"),0;this.annotations.splice(o,1)}}this.annotations.push(n),this.getDetailedAnnotations()},removeFromModelCache(t,e){const s=this.modelResultCache.indexOf(e);this.modelResultCache.splice(s,1)},removeAnnotation(t,e){const s=this.annotations.indexOf(e);this.annotations.splice(s,1),this.getDetailedAnnotations()},key(t){console.log("key pressed: ",t.key)},compressAnnotations(){},saveAnnotations(){if(Object.keys(this.conflicts).length>0){const t="You must resolve all conflicts before saving.";return this.$q.notify({message:t,color:"secondary",position:"center",actions:[{label:"Dismiss",color:"white",handler:()=>{}}]}),-1}this.saving=!0;const t={document:this.document.id,annotations:"ner"===this.mode||"sentence"===this.mode?this.annotations:this.relations,kind:this.mode};let e,s;"ner"!==this.mode&&"sentence"!==this.mode||!this.document.annotations.id?"relation"===this.mode&&this.document.relations.id?(s="patch",e=this.$hostname+"/api/annotations/"+this.document.relations.id+"/"):(s="post",e=this.$hostname+"/api/annotations/"):(s="patch",e=this.$hostname+"/api/annotations/"+this.document.annotations.id+"/"),0===this.annotations.length&&console.log(0),this.$axios({method:s,url:e,data:t}).then((e=>{this.saving=!1,!this.isAnnotated&&t.annotations.length>=1?(this.incrProgress(1),this.isAnnotated=!0):this.isAnnotated&&0===t.annotations.length&&(this.incrProgress(-1),this.isAnnotated=!1),this.document.annotations=e.data}))},incrProgress(t){this.numAnnotated+=t},fetchDocs(t){let e;if(this.tokens=[],this.relation={relation:null,head:{},tail:{},hint:{}},this.$q.loading.show({message:"Fetching documet from server and set it up for curation. This may take a few seconds."}),t.url){const s=t.url.split("/").length;e="/"+t.url.split("/").splice(s-3,s).join("/")}else e=`/api/documents/?project=${this.project.id}&review=${this.review}&consensus=${this.consensus}&mode=${this.mode}`,t.page&&(e+=`&page=${t.page}`);this.$axios.get(e).then((t=>{this.documents=t.data.results,this.nextURL=t.data.next,this.prevURL=t.data.previous,this.document=this.documents[0];const e=this.document.annotations.id?this.document.annotations.annotations:[];this.document.related?this.relevantSentences=this.document.related.annotations:this.relevantSentences=[],this.annotations=e.filter((t=>this.labelNames.has(t.name))),this.review&&(this.annotations4Review=this.document.reviews,this.annotations=this.mergeAnnotations()),"relation"===this.mode&&(this.relations=this.document.relations.id?this.document.relations.annotations:[]),this.consensus&&(this.document.gold.annotations.forEach((t=>{t.id=this.lLabels[t.name]?this.lLabels[t.name].id:null})),this.annotations=this.document.gold.annotations),this.isAnnotated=this.document.annotations.id,this.tokens=this.document.tokens,this.sentences=this.document.sentences,("ner"===this.mode||"relation"===this.mode&&!this.review)&&this.getDetailedAnnotations(),this.highlighted=[],this.processedQ=[],this.modelQueue=[],this.consensus&&this.project.cmodels.forEach((t=>{this.cmodels[t.id].consensusScore.f1=null})),this.$q.loading.hide(),this.postConstruct()})),this.modelResultCache=null,this.$refs.textArea.setScrollPosition("vertical",0)},postConstruct(){},alignTokens(t){t.forEach((t=>{t.name||(t.name=this.labels[t.id].name);const e=t.tpos[0],s=t.tpos[1],n=t.pos[0],o=t.pos[1];for(let i=0;i<this.tokens.length;i++)this.tokens[i][2]===n?(t.tpos[0]=i,e===s&&(t.tpos[1]=i)):this.tokens[i][2]>n&&this.tokens[i][2]<o&&(t.tpos[1]=i)}))},getDetailedAnnotations(){this.detailedAnnotations=new Array(this.tokens.length).fill(null),this.annotations.forEach((t=>{t.name||(t.name=this.labels[t.id].name);const e=t.tpos[0],s=t.tpos[1],n=t.pos[0],o=t.pos[1];let i;for(let a=0;a<this.tokens.length;a++)this.tokens[a][2]===n?(t.tpos[0]=a,e===s&&(t.tpos[1]=a),i=["B",t],this.detailedAnnotations[a]||(this.detailedAnnotations[a]=[]),this.detailedAnnotations[a].push(i)):this.tokens[a][2]>=n&&this.tokens[a][2]<=o&&(t.tpos[1]=a,i=["I",t],this.detailedAnnotations[a]||(this.detailedAnnotations[a]=[]),this.detailedAnnotations[a].push(i))})),this.getLabelOrder()},getKey(t){return`${t[1].name}-${t[1].pos[0]}-${t[1].pos[1]}`},getLabelOrder(){const t=[];this.detailedAnnotations.forEach(((e,s)=>{if(e){const n={},o=[];let i=Array(e.length).fill().map(((t,e)=>e));e.forEach(((e,i)=>{const a=this.getKey(e);if(0===s)n[a]=i;else if("I"===e[0]){const s=t[e[1].tpos[0]][this.getKey(e)];n[a]=s,o.push(s)}})),i=i.filter((t=>!o.includes(t))),s>0&&e.forEach(((t,e)=>{const s=this.getKey(t);"B"===t[0]&&(n[s]=i.shift())})),t.push(n)}else t.push(null)})),this.annotationOrders=t},getSelection(t){this.highlight(this.documents[0].text,t.start,t.end)},highlight(t,e,s){this.text=`${t.substring(0,e)}<span style="background-color: red">${t.substring(e,s)}</span>${t.substring(s)}`},getTokenOffsetTop(t){const e="t-"+t;return document.getElementById(e).getBoundingClientRect().top},puncts(){console.log("get puncts",new Date);const t=[],e=[",",".",":","!","?","'"];for(let s=0;s<this.tokens.length;s++){const n=this.tokens[s][0][0];t[s]=-1!==e.indexOf(n[0][0])}return console.log("get puncts 2",new Date),t}},computed:{selectedClasses(){const t={};return this.selected.forEach((e=>{t[e]="selected"})),t},progressStats(){const t=this.project.num_of_annotated_docs+this.numAnnotated,e=t/this.project.num_of_docs,s=(100*e).toFixed(2)+"%"+` (${t}/${this.project.num_of_docs})`;return{pct:e,label:s}},categorizedAnnotations(){const t={};return this.annotations.forEach((e=>{[e].forEach((e=>{const s=e.name||this.labels[e.id].name;t[s]?t[s].push(e):t[s]=[e]}))})),t},conflicts(){const t={};this.annotations.forEach((e=>{const s=JSON.stringify(e.pos);t[s]?t[s].push(e):t[s]=[e]}));const e={};return Object.keys(t).forEach((s=>{t[s].length>1&&(e[s]=t[s])})),e},lLabels(){const t={};return Object.entries(this.labels).forEach((e=>{t[e[1].name]=e[1]})),t},tokensInRS(){const t=[];if(this.relevantSentences&&this.relevantSentences.length>0){for(let e=0;e<this.relevantSentences.length;e++){const s=this.relevantSentences[e],n=this.sentences[s].start,o=this.sentences[s].end;for(let e=n;e<o;e++)t.push(e)}return t}}},watch:{}}}}]);